name: Deploy to EC2 on tag (self-hosted)

on:
  push:
    tags:
      - "v*"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy tag to live folder and restart
        run: |
          set -e

          echo "Deploying tag: $GITHUB_REF_NAME"

          cd /var/www/webapp

          # Ensure we're using your repo folder and it has the latest tags
          git fetch --all --tags

          # Checkout exactly the tag that triggered the workflow
          git checkout -f "$GITHUB_REF_NAME"

          # Deterministic install (uses package-lock.json)
          npm ci --omit=dev

          # Restart the app
          pm2 restart webapp

          # Reload nginx (safe even if no changes)
          sudo systemctl reload nginx

          echo "Deploy complete."
